<html>

<head>

    <script>
        // load today's data
        $(document).ready(function() {
            // load today's available bookings
            var dateTimeData = jsonData();
            var dynamicDateDiv = $('.dynamic-date-board');
            var todayNum = date_call(9); // 9, (1-31)
            var todayFullForm = date_call(10); // Tuesday, March 9, 2021
            // json_Loop(dateTimeData, dynamicDateDiv, todayFullForm);
            checkBookingData(dateTimeData, dynamicDateDiv, todayFullForm);

            var str = '<h1>Today</h1><h5>' + todayFullForm + '</h5>';
            $('#dynamic-date').html(str);

            var todayName = date_call(2); // Tuesday
            var thisMonth = date_call(5); // March
            var thisMonthNum = date_call(3); // 2 (starts from 0)
            var thisYear = date_call(6); // 2021
            var todayNumWeek = date_call(1); // 2, (0-6)

            // add date attributes to the div
            $('#dynamic-date').attr('data-date-name', todayName); // Tuesday
            $('#dynamic-date').attr('data-month-name', thisMonth); // March
            $('#dynamic-date').attr('data-month-num', thisMonthNum); // 2 (starts from 0)
            $('#dynamic-date').attr('data-date', todayNum); // 9, (1 - 31)
            $('#dynamic-date').attr('data-date-week', todayNumWeek); // 2, (0 - 6)
            $('#dynamic-date').attr('data-year', thisYear); // 2021
            $('#dynamic-date').attr('data-date-full', todayFullForm); // Tuesday, March 9, 2021
        });
        /*
            this function receives today's full date format as parameter: Tuesday, March 9, 2021
            Then it makes ajax call to the database
            it returns all days booked for the day from db
        */
        function checkBookingData(jDATA, divID, specify) {
            var hoursArray = new Array();
            var counter = 0;

            // fetch booking data
            $.ajax({
                url: 'https://3i71kk5ced.execute-api.us-east-1.amazonaws.com/GetRecordsTest/getdynamodbitems',
                type: "GET",

                success: function(db_data) {

                    db_data.Items.forEach(function(Item) {
                        // if fetched date is same as today
                        if (Item.date.S == specify) {
                            // store hours for the day in an array
                            hoursArray[counter] = Item.time.S;
                            counter++;
                        }

                    });

                    // send data to UI
                    deploy_data(jDATA, divID, specify, hoursArray);

                },
                error: function() {
                    alert('fetch request failed in: checkBookingData)');
                }
            });
        }


        // weekly data generator
        function weekly_data_generator(num) {
            // call for the current data from the div
            // var todayName = $('#dynamic-date').attr('data-date-name'); // Tuesday
            var thisMonth = $('#dynamic-date').attr('data-month-name'); // March
            var thisMonthNum = parseInt($('#dynamic-date').attr('data-month-num')); // 2
            var currDate = parseInt($('#dynamic-date').attr('data-date')); // 9
            var thisYear = parseInt($('#dynamic-date').attr('data-year')); // 2021

            // at button click, subtract from todayNumWeek & currDate
            if (num == -1) {
                currDate -= 1;
            } else if (num == 1) {
                currDate += 1;
            }

            // make sure the day doesn't go beyound limit -ve or 32 >
            // creating a date object based on updated date number
            var newDateObj = new Date(thisYear, thisMonthNum, currDate); //input: '2011', '01', '15'
            var newDateNum = newDateObj.getDate(); // 8, (1 - 31) updated date
            var newDayNum = newDateObj.getDay(); // 1, (0 - 6) updated day
            var weekdays = date_call(7); // array [Su, Mo ..]
            var modifiedDateName = weekdays[newDayNum]; // Monday  
            var newMonthNum = newDateObj.getMonth(); // 2, (0 - 11) updated month
            var months = date_call(8); // months names array
            var newMonthName = months[newMonthNum]; // March, updated month name
            var newYear = newDateObj.getFullYear(); // 2021, updated year
            var newDayFullForm = modifiedDateName + ', ' + newMonthName +
                ' ' + newDateNum + ', ' + newYear; // Tuesday, March 9, 2021

            var str = '<h1>' + modifiedDateName + '</h1><h5>' + newMonthName + ' ' +
                newDateNum + ', ' + newYear + '</h5>';

            $('#dynamic-date').html(str);

            // update attribute for this day
            $('#dynamic-date').attr('data-date-name', modifiedDateName); // Tuesday
            $('#dynamic-date').attr('data-month-name', newMonthName); // March
            $('#dynamic-date').attr('data-month-num', newMonthNum); // 2 (starts from 0)
            $('#dynamic-date').attr('data-date', newDateNum); // 9, (1 - 31)
            $('#dynamic-date').attr('data-date-week', newDayNum); // 1, (0 - 6)
            $('#dynamic-date').attr('data-year', newYear); // 2021
            $('#dynamic-date').attr('data-date-full', newDayFullForm); // Tuesday, March 9, 2021

            // update the booking
            var dateTimeData = jsonData(); //json data
            var dynamicDateDiv = $('.dynamic-date-board'); // the div

            var fullDayToday = modifiedDateName + ', ' + newMonthName + ' ' + newDateNum + ', ' + newYear; // Tuesday, March 9, 2021

            // update the div with data
            // json_Loop(dateTimeData, dynamicDateDiv, fullDayToday);
            checkBookingData(dateTimeData, dynamicDateDiv, fullDayToday);
        }

        function retrievePrevData(e) {
            var num = -1;
            // call
            weekly_data_generator(num);
        }

        function retrieveNextData(e) {
            var num = 1;
            // call
            weekly_data_generator(num);
        }

        /* 
        this function holds json of date and time
        mimics the data received from server
        to get the data obj, call this function: var varName = jsonData();

    */
        function jsonData() {
            // json of date and time
            var dateTimeData = [{
                crDate: "Wednesday, December 30, 2020",
                crTime: "10:00am - 12:00pm"
            }, {
                crDate: "Monday, February 28, 2021",
                crTime: "10:00am - 12:00pm"
            }, {
                crDate: "Friday, February 26, 2021",
                crTime: "10:00am - 12:00pm"
            }, {
                crDate: "Monday, March 1, 2021",
                crTime: "10:00am - 12:00pm"
            }, {
                crDate: "Tuesday, March 2, 2021",
                crTime: "9:00am - 10:00am"
            }, {
                crDate: "Wednesday, March 3, 2021",
                crTime: "11:00am - 12:00pm"
            }, {
                crDate: "Wednesday, March 3, 2021",
                crTime: "2:00pm - 3:00pm"
            }, {
                crDate: "Thursday, March 4, 2021",
                crTime: "2:00pm - 3:00pm"
            }, {
                crDate: "Friday, March 5, 2021",
                crTime: "2:00pm - 3:00pm"
            }, {
                crDate: "Saturday, March 6, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Saturday, March 6, 2021",
                crTime: "12:00pm - 2:00pm"
            }, {
                crDate: "Sunday, March 7, 2021",
                crTime: "12:00pm - 2:00pm"
            }, {
                crDate: "Monday, March 8, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, March 9, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, March 9, 2021",
                crTime: "11:00am - 12:00pm"
            }, {
                crDate: "Wednesday, March 10, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Wednesday, March 10, 2021",
                crTime: "11:00am - 1:00pm"
            }, {
                crDate: "Wednesday, March 10, 2021",
                crTime: "2:00pm - 4:00pm"
            }, {
                crDate: "Thursday, March 11, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, March 4, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, March 11, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Friday, March 12, 2021",
                crTime: "2:00pm - 3:00pm"
            }, {
                crDate: "Saturday, March 13, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Sunday, March 14, 2021",
                crTime: "12:00pm - 2:00pm"
            }, {
                crDate: "Monday, March 15, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, March 16, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, March 16, 2021",
                crTime: "11:00am - 12:00pm"
            }, {
                crDate: "Wednesday, March 17, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, March 18, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, March 18, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, March 18, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Friday, March 19, 2021",
                crTime: "2:00pm - 3:00pm"
            }, {
                crDate: "Saturday, March 20, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Sunday, March 21, 2021",
                crTime: "12:00pm - 2:00pm"
            }, {
                crDate: "Monday, March 22, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, March 23, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, March 23, 2021",
                crTime: "11:00am - 12:00pm"
            }, {
                crDate: "Wednesday, March 24, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, March 25, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, March 25, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, March 25, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Friday, March 26, 2021",
                crTime: "2:00pm - 3:00pm"
            }, {
                crDate: "Saturday, March 27, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Sunday, March 28, 2021",
                crTime: "12:00pm - 2:00pm"
            }, {
                crDate: "Monday, March 29, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, March 30, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, March 30, 2021",
                crTime: "11:00am - 12:00pm"
            }, {
                crDate: "Wednesday, March 31, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, April 1, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, April 1, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, April 1, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Friday, April 2, 2021",
                crTime: "2:00pm - 3:00pm"
            }, {
                crDate: "Saturday, April 3, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Sunday, April 4, 2021",
                crTime: "12:00pm - 2:00pm"
            }, {
                crDate: "Monday, April 5, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, April 6, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Tuesday, April 6, 2021",
                crTime: "11:00am - 12:00pm"
            }, {
                crDate: "Wednesday, April 7, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, April 8, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, April 8, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Thursday, April 8, 2021",
                crTime: "8:00am - 10:00am"
            }, {
                crDate: "Friday, April 9, 2021",
                crTime: "2:00pm - 3:00pm"
            }, {
                crDate: "Saturday, April 10, 2021",
                crTime: "8:00am - 10:00am"
            }];

            return dateTimeData;
        }

        /* 
        loops through json for daily table
    */
        function deploy_data(jDATA, divID, specify, todayHoursArrayDb) {
            var str = '';
            var dup = []; // array of string
            var counter = 0;

            // for each data (date & time) from json
            $.each(jDATA, function(key, value) {
                // if bookDate from json equals today
                if (value.crDate.includes(specify)) {
                    // if there are no booked hours for the day
                    if (todayHoursArrayDb.length == 0) {
                        str = '<div class="col-md-3 card-on calendarForm">';
                        str += '<h5 class="tblDate">' + value.crDate + '</h5>';
                        str += '<h6 class="tblTime">' + value.crTime + '</h6>';
                        str += '<button class="btn btn-primary btn-block" data-toggle = "modal" data-target = "#calModal">Book</button>';
                        str += '</div>';
                        // save data into a new array
                        dup[counter] = str;
                        counter++;
                    } else if (todayHoursArrayDb.length > 0) {
                        // loop through hours of today
                        // check if booked hours from database equal today hours from json file
                        for (var i = 0; i < todayHoursArrayDb.length; i++) {
                            // alert('working...') 
                            // if json hour equals booked hour, disable it. Booked!
                            if (value.crTime === todayHoursArrayDb[i]) {
                                // make the button gray
                                str = '<div class="col-md-3 card-on calendarForm grey">';
                                str += '<h5 class="tblDate">' + value.crDate + '</h5>';
                                str += '<h6 class="tblTime">' + value.crTime + '</h6>';
                                str += '<button class="btn btn-secondary btn-block" data-toggle = "modal" disabled>Booked</button>';
                                str += '</div>';
                                // save data into a new array
                                dup[counter] = str;
                                counter++;

                            } else {
                                str = '<div class="col-md-3 card-on calendarForm">';
                                str += '<h5 class="tblDate">' + value.crDate + '</h5>';
                                str += '<h6 class="tblTime">' + value.crTime + '</h6>';
                                str += '<button class="btn btn-primary btn-block" data-toggle = "modal" data-target = "#calModal">Book</button>';
                                str += '</div>';
                                // save data into a new array
                                dup[counter] = str;
                                counter++;
                            }
                        }
                    }
                }
            });
            // if duplicated, remove index
            var uniqueArray = removeDuplicateValue(dup);
            // convert array back to string
            var newVal = uniqueArray.join("");
            // add to html div
            $(divID).html(newVal);

            // MODAL and ajax call
            MODAL_Loader();
        }

        // Defining function to get unique values from an array
        function removeDuplicateValue(dupArray) {
            var uniqueArray = [];

            // Loop through array values
            for (var value of dupArray) {
                if (uniqueArray.indexOf(value) === -1) {
                    uniqueArray.push(value);
                }
            }
            return uniqueArray;
        }

        /* 
        loops through json for daily table
    */
        function json_Loop(jDATA, divID, specify) {
            var str = '';

            // for each data (date & time) from json
            $.each(jDATA, function(key, value) {
                if (value.crDate.includes(specify)) { // check if it is for today

                    str += '<div class="col-md-3 card-on calendarForm">';
                    str += '<h5 class="tblDate">' + value.crDate + '</h5>';
                    str += '<h6 class="tblTime">' + value.crTime + '</h6>';
                    str += '<button class="btn btn-primary btn-block" data-toggle = "modal" data-target = "#calModal">Book</button>';
                    str += '</div>';
                }
            });

            $(divID).html(str);

            // MODAL and ajax call
            MODAL_Loader();
        }

        /* 
        this function produces an array of date data
        date_call[0] - date - current date: Sat Mar 06 2021 06:05:55 GMT-0500 (Eastern Standard Time)
        date_call[1] - dateNumWeek - current date num: 6, (0 - 6)
        date_call[2] - dateName - current date num: Saturday
        date_call[3] - calMonthNum - current month num: 2 (starts count from 0)
        date_call[4] - calMonthNumCorrected - adds 1 to month: 3
        date_call[5] - calMonthName - current month name: March
        date_call[6] - theYear - adds 1 to month: 2021
        date_call[7] - weekdays - weedays array 
        date_call[8] - months - months array
        date_call[9] - dateNumMonth - current date num: 15, (1-31)
        date_call[10] - fullDayToday - // Thursday, March 4, 2021

        it receives one arguments: the array number
        then it returns the required date value
        to call this func: var today = date_call(n);
    */
        function date_call(num) { //num
            var date = new Date(); //Sat Mar 06 2021 06:05:55 GMT-0500 (Eastern Standard Time)
            var dateNumWeek = date.getDay(); // 6, (0 - 6)
            var dateNumMonth = date.getDate(); // 15, (1-31)
            var weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            var dateName = weekdays[dateNumWeek]; // Saturday  
            var calMonthNum = date.getMonth(); // 2 (starts from 0)
            var calMonthNumCorrected = date.getMonth() + 1; // 3
            var months = [
                "January", "February", "March",
                "April", "May", "June", "July", "August",
                "September", "October", "November", "December"
            ];
            var calMonthName = months[calMonthNum]; // March
            var theYear = date.getFullYear(); // 2021
            var fullDayToday = dateName + ', ' + calMonthName + ' ' + dateNumMonth + ', ' + theYear; // Thursday, March 4, 2021

            var dateArr = [
                date, dateNumWeek, dateName, calMonthNum,
                calMonthNumCorrected, calMonthName, theYear,
                weekdays, months, dateNumMonth, fullDayToday
            ]; // holds date formats
            // var test = fullDayToday;
            return dateArr[num]; // dateArr[num]
        }

        /*
        // MODAL Loader
        // saving data to DynamoDb: reqDate, reqTime, cusName, cusPhone, cusEmail
        // when clicked 'book', capture calendar date and time
    */
        function MODAL_Loader() {
            // MODAL Loader ... for month
            $(".calendarForm").find("button").click(function() {
                var btnParent = $(this).parent(); // parent div for button
                var reqDate = $(btnParent).find(".tblDate").text(); // tuesday ...
                var reqTime = $(btnParent).find(".tblTime").text(); // 6:00am 

                // update modal with date and time
                $('#modalDate').html(reqDate);
                $('#modalTime').html(reqTime);

            });
        }
    </script>
</head>

<body>
    <h1>Daily Calendar View</h1>
    <div class="row">
        <h4>Book the date and time of your choosing.</h4>
        <div class="col-md-12" id="table-vertical">

            <div class="row">
                <div class="col-lg-12 arrow">
                    <div class="col-xs-6">
                        <i class="fa fa-arrow-circle-left" onClick="retrievePrevData(event)"></i>
                    </div>
                    <div class="col-xs-6">
                        <i class="fas fa-arrow-circle-right" onClick="retrieveNextData(event)"></i>
                    </div>
                </div>
            </div>

            <div class="row">

                <div class="col-md-3">
                    <div class="spacer"></div>
                    <h4 id="dynamic-date">Today</h4>
                </div>
                <div class="col-md-12 card-on dynamic-date-board">
                    <div class="col-md-3 card-on">
                        <h5 class="tblDate">Thursday, March 4, 2021 </h5>
                        <h6 class="tblTime">9:00am - 10:00am</h6>
                        <button class="btn btn-primary btn-block" data-toggle="modal" data-target="#calModal">Book</button>
                        <code class="text-lowercase font-italic">(Time slot placeholder)</code>
                    </div>

                    <div class="col-md-3 card-on">
                        <h5 class="tblDate">Thursday, March 4, 2021</h5>
                        <h6 class="tblTime">9:00am - 10:00am</h6>
                        <button class="btn btn-primary btn-block" data-toggle="modal" data-target="#calModal">Book</button>
                        <code class="text-lowercase font-italic">(Time slot placeholder)</code>
                    </div>
                </div>

            </div>

        </div>

        <script>
            var url = "./assets/js/book/bookSeed.js";
            $.getScript(url);
        </script>
    </div>
</body>

</html>